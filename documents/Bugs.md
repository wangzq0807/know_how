## 关机卡住
### 一、问题描述
接入U盘启动盘进入liveCD界面，进行关机或重启操作，在关机过程中，会卡在关机动画27秒左右
按ESC键，看到如下提示信息：
>【FAILED】Failed unmounting cdrom.mount</br>

补充现象:
  - (1)U盘安装，图形动画模式，问题重现
  - (2)U盘安装，文字动画模式，无此问题
  - (3)PXE安装，图形/文字模式，无此问题
### 二、原因分析
1. 整个问题的切入点: CDOS-3.0没有这个问题，CDOS-3.1出现这个问题
  从这个切入点来看，我们只需排查3.1与3.0的不同点。
  已知3.1与3.0不同的软件包有400+，挨个排查太耗时，
  根据现象，首选的排查对象有两个:
    - (1)关机动画
    - (2)内核
2. 关机动画的排查
  关机动画由Plymouth来实现，我们采用下面的方法来检查Plymouth
    (1)将CDOS-3.0中的Plymouth升级，升级到CDOS-3.1中相同版本 -->没有问题
    (2)将CDOS-3.1中的Plymouth降级，降级到CDOS-3.0中相同版本 -->问题仍在
  通过上面两步，基本可以排除Plymouth。
  虽然Plymouth不是根本原因，但根据[问题描述]中的补充现象来推断，
  我们可以确定Plymouth是这个问题的直接诱因.
  接下来，我们关注的重点就是:Plymouth如何诱发了这个Bug。
  要确定这个问题，需要打印出Plymouth的log。
  在grub启动项中，添加内核启动参数：plymouth:debug，
  有这个参数时plymouth就会输出log: /var/log/plymouth-debug.log
  但关机操作比较特殊，硬盘驱动被关闭，我们拿不到log文件，只能从屏幕上获取log
  一般情况下，log仅在文字动画模式时才打印到屏幕上，但文字动画模式，没有这个bug
  比较幸运的是，系统自带了多种开关机动画，其中一种动画名为spinfinity，
  它虽然是图形动画，却能同时在屏幕上显示plymouth的log.
  通过log分析发现，plymouth卡在了调用Pango库函数的位置，
  Pango是一个字体渲染库，plymouth用它来显示文字[请移除安装介质...]。
  这就间接解释了补充现象(3)，因为PXE安装时，不会显示这行文字
3. 内核的排查
  与Plymouth的排查类似，通过对内核版本升级/降级，排除了内核的原因
4. 其他软件包的排查
  经过原因分析2.的分析，得出了调用Pango库函数会卡一段时间的结论。
  我们对Pango这个库不熟悉，如果直接去看Pango的源码，肯定不会有太多收获.
  但Pango为我们确定了一个筛选软件包的范围: [图形] 和 [字体]
  从400+软件包中筛选出图形、字体相关的包，共有30几个。
  通过对这30几个软件包升级/降级，最终确定了fontconfig包
5. fontconfig的分析
  我们注意到fontconfig安装时，耗时很长，约33秒，同关机卡住的27秒很接近。
  因此猜测fontconfig安装时执行命令与关机动画存在联系。
  解压fontconfig安装包，发现fontconfig安装后执行了fc-cache命令，
  这条命令是用来生成字体缓存的。
  另外我们发现，只要我们在关机前执行一遍fc-cache命令,那么关机就不会卡住
  通过查看fc-cache的帮助文档,我们认为fc-cache应该在构建ISO时执行,
  也就是说只要构建ISO完成后，执行一次fc-cache命令，那么关机就不应该卡住
6. 构建组协助
  构建组按照我们的想法，将fc-cache命令的执行，放在了构建ISO结尾位置.
  使用新的ISO制作U盘，进入LiveCD环境后，关机仍然卡住了.
  至此，线索就中断了，只能阅读fc-cache的代码.
7. 字体缓存机制
  通过阅读fc-cache的代码，我们知道，字体缓存中记录了字体的修改时间，
  如果字体的修改时间与字体缓存中的时间一致，则不需要重新生成字体缓存，
  如果字体的修改时间与字体缓存中的时间不一致，则要重新生成字体缓存。
  重新生成字体缓存的时间较长,会导致应用程序看起来像是卡住了.
  通过查看ISO中字体的修改时间与缓存中记录的时间，发现两者存在细微差别:
    字体修改时间的时间戳是个整数，小数点后面全是0
    缓存中记录的时间戳比字体修改时间多了小数部分
  根据我们对ext4文件系统的了解，字体修改时间的时间戳不可能是个整数。
  除非使用了其他文件系统
8. squashfs文件系统
  在制作ISO的最后，要使用squashfs对整个文件系统进行打包，这个文件系统
  不支持小数时间戳，因此在打包的过程中，文件时间戳的小数部分会被擦掉，
  从而导致字体缓存中记录的时间戳与字体实际的时间戳不一致

### 三、可能的方案及验证实施
1. 将文字预先转为图片，在开机动画时显示
  根据原因分析2,关机卡在了渲染文字[请移除安装介质...]的地方,因此,
  其中一个方案就是将这行文字使用作图软件制作成图片,关机时直接显示这张图片，
  省略了文字渲染的步骤，从而解决这个问题.
  经过验证,这个方案是可行的,但这个方案是治标不治本的，所以不采纳
2. 在构建ISO结尾的位置执行fc-cache命令
  根据原因分析5,我们认为只要在构建ISO时,执行了fc-cache,就能解决这个问题，
  但经过构建组的验证,这个方案不可行
3. 字体缓存在记录时间戳时，仅记录整数部分，忽略小数
  根据原因分析8,squashfs不支持小数点时间戳,
  因此只要我们的字体缓存跟它保持一致,也不支持小数点,就能解决这个问题,
  这个方案找到了问题的根本原因,因此采用这个方案

### 四、所需的背景知识
1. 动画的实现
  动画实际上是多张图片,按照一定的顺序,一定的时间间隔，依次显示出来，
  最终实现动画的效果.
2. 通过grub修改内核启动参数
  在ISO中有一个isolinux目录，这个目录里有一个txt.cfg，
  这个文件是指定了liveCD启动的菜单项，通过这个文件可修改内核参数
3. ISO的制作方式
  参考文档《手动修改基础版ISO方法》
4. 文件系统的差别
  不同的文件系统所支持的特性是不同的
  例如:ext3文件系统是不支持纳秒时间戳的,ext4开始支持纳秒时间戳,
  通过这个bug我们发现squashfs也不支持纳秒时间戳.
5. 字体缓存的作用
  请参考fc-cache的帮助文档

### 五、小结
对于不同版本的CDOS,一个发生Bug，另一个不发生Bug，这种情况，
我们都可以通过排查软件包异同的办法来确定问题发生的原因。
当两个版本之间差别的软件包较多时，这种方法会比较慢，
可能需要其他辅助方法来确定一个最小的排查范围